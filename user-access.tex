
changequote([[[, ]]])

\pagebreak
\pdfbookmark[0]{access rights, peripheal devices, file system}{soubory}

\begin{slide}
\sltitle{Contents}
\slidecontents{3}
\end{slide}

\begin{slide}
\sltitle{Users and groups}
\begin{center}
\framebox{\texttt{beran:x:1205:106:Martin Beran:/home/beran:/bin/bash}}
\end{center}
\vspace{2ex}

\emsl{The fields, in order from left to right:} user name, 
hashed password (today in \texttt{/etc/shadow} or elsewhere), user ID (aka UID);
primary group ID (aka GID), full name, home directory, login shell

Note that a superuser (root) has always UID 0.

\vspace{2ex}
\begin{center}
\framebox{\texttt{sisal:*:106:forst,beran}}
\end{center}
\vspace{2ex}

\emsl{The fields, in order from left to right:} group name, group password (not
used today), group ID (GID), list of group members
\end{slide}

\begin{itemize}
\item User information in files \texttt{/etc/passwd} and \texttt{/etc/group} are
processed by various system programs, like \texttt{login} or \texttt{su}.
The kernel knows nothing about these files as it only uses numeric
representation of users and groups.
\item Passwords are long gone from \texttt{/etc/passwd}, they are stored some
place else, for example in \texttt{/etc/shadow}, which is not readable to an
uprivileged user.  The passwords are also salted and then hashed.  On BSD based
systems, eg. FreeBSD or macOS, instead of \texttt{/etc/shadow},
\texttt{/etc/master.passwd} database is used.
\item If \texttt{/etc/shadow} does exist, it is structured in a similar way as
\texttt{/etc/passwd}.
\item There are also protocols used for autentization that do not use
\texttt{/etc/passwd} at all, for example NIS (Network Information Service) or
LDAP (Lightweight Directory Access Protocol).
\item The user group in \texttt{/etc/passwd} is called \emph{primary} for the
user.  Such a group is used when files are created.  Other groups a user belongs
to, those in the user's entry in \texttt{/etc/group}, are called
\emph{supplementary} and provide additional group privileges to access files.
\end{itemize}

%%%%%

\pdfbookmark[1]{file access rights}{fsaccessrights}

\begin{slide}
\sltitle{Pøístupová práva}
\begin{center}
\input{img/tex/prava.tex}
\end{center}
\begin{itemize}
\item \emsl{SGID} pro soubor bez práva spu¹tìní pro skupinu v System
V: kontrola zámkù pøi ka¾dém pøístupu (\emsl{mandatory locking})
\item \emsl{sticky bit} pro adresáøe: právo mazat a pøejmenovávat
soubory mají jen vlastníci souborù 
\item \emsl{SGID} pro adresáø: nové soubory budou mít stejnou
skupinu jako adresáø (System V; u BSD systémù to funguje jinak, viz
poznámky)
\end{itemize}
\end{slide}

\begin{itemize}
\item SGID pro adresáøe u BSD systémù zpùsobí, ¾e soubory a podadresáøe
vytvoøené v tomto adresáøi budou mít stejného majitele jako je majitel daného
adresáøe. Nutným pøedpokladem je dále to, ¾e daný UFS filesystém musí být
namontován s suiddir pøíznakem a v jádru je option SUIDDIR (a to není
default). Navíc to nefunguje pro roota. Tato mo¾nost existuje kvùli Sambì a
Nettalku.
\item sticky bit pro adresáøe: pøejmenovat nebo smazat soubor mù¾e jen jeho
vlastník (v~nìkterých implementacích staèí i právo zápisu do souboru),
ne\-sta\-èí právo zápisu do adresáøe. Toto nastavení se pou¾ívá pro veøejné
adresáøe (napø. \texttt{/tmp}).
\item pùvodnì mìl sticky bit význam i pro spustitelné soubory: program s
nastaveným sticky bitem zùstal po ukonèení v pamìti a jeho opìtovné spu¹tìní
bylo rychlej¹í. Dnes se sticky bit v tomto významu u¾ nepou¾ívá.
\item nìkteré filesystémy (XFS, AFS, UFS2, ZFS) mají tzv. access control lists
(ACLs), které dovolují jemnìj¹í pøidìlování práv jednotlivým u¾ivatelùm a
skupinám.
\end{itemize}
%%%%%

\pdfbookmark[1]{getpwnam, getpwuid, getpwent}{getpw}

\label{GETPW_FUNC}
\begin{slide}
\sltitle{Obtain user/group information}
\begin{itemize}
\item \texttt{struct passwd *\funnm{getpwnam}(const char *name)}

return structure describing user found in password database or NULL.

\item \texttt{struct passwd *\funnm{getpwuid}(uid\_t uid)}

ditto; perform search according to UID.

\item \texttt{void \funnm{setpwent}(void)}
\item \texttt{void \funnm{endpwent}(void)}
\item \texttt{struct passwd *\funnm{getpwent}(void)}

these functions traverse password database. \funnm{setpwent} rewinds to the
beginning of the password database, \funnm{getpwent} gets the current entry,
\funnm{endpwent} closes the password database and free allocated resources.
\end{itemize}
\end{slide}

\begin{itemize}
\item tyto funkce fungují nezávisle na tom jak z jaké databáze byly
získány informace o daném u¾ivateli.
\item v¹echny tyto funkce jsou souèástí POSIX 1003.1-2008 (sekce XSH)
\item \funnm{setpwent} je tøeba zavolat pøed prvním voláním \funnm{getpwent}
\item analogicky exitují funkce \funnm{getgrnam} a \funnm{getgrent} které
získávají informace o skupinách.
\item pro prohledávání a výpis databazí lze pou¾ít program
\texttt{getent}. Napø. k nalezení záznamu u¾ivatele a skupiny
\texttt{root}:

\begin{verbatim}
$ getent passwd root
root:x:0:0:Super-User:/root:/sbin/sh
$ getent group root
root::0:
\end{verbatim}
\end{itemize}

%%%%%

\pdfbookmark[1]{name service switch}{NSS}

\begin{slide}
\sltitle{Name service switch}
\begin{itemize}
\item today's systems are not confined to only using
\texttt{/etc/passwd} and \texttt{/etc/groups}
\item such systems have \emph{databases} (passwd, groups, protocols, \dots)
\item database data come from \emph{sources} (files, DNS, NIS, LDAP, \dots)
\item file \texttt{nsswitch.conf} defines what databases use what sources
\item library functions must support this, obviously
\item it is possible to combine some sources, eg. users may be first be searched
in \texttt{/etc/passwd}, then in LDAP
\item came first with Solaris, other systems took over the idea
\end{itemize}
\end{slide}

\begin{itemize}
\item Systems using the name service switch typically have
\texttt{nsswitch.conf(4)} where you can find information about what databases
are supported, including the API.  For example, with the \texttt{passwd}
database, standard calls like \texttt{getpwnam(3)} and \texttt{getpwent(3)} use
it.  In general, it is not needed to process such databases manually as there is
always an API to use for that.
\item Example of an existing \texttt{nsswitch.conf} on Solaris:

\begin{verbatim}
passwd:     files ldap
group:      files ldap

# You must also set up the /etc/resolv.conf file for DNS name
# server lookup.  See resolv.conf(4).
hosts:      files dns

# Note that IPv4 addresses are searched for in all of the
# ipnodes databases before searching the hosts databases.
ipnodes:   files dns

networks:   files
protocols:  files
rpc:        files
ethers:     files
\end{verbatim}
\end{itemize}

%%%%%

\pdfbookmark[1]{Access rights evaluation algorithm}{accessrights}

\begin{slide}
\sltitle{Access rights testing}
\setlength{\baselineskip}{0.9\baselineskip}
\begin{itemize}
\item user is identified with (\emsl{UID}) number and group numbers
for groups he belongs to (\emsl{primary GID}, \emsl{supplementary GIDs}).
\item this identification is inherited by each process
\item file $F$ has owner ($UID_F$) and group owner ($GID_F$). 
\item algorithm for evaluation of access rights for process:
$P(UID_P,GID_P,SUPG)$ and file $F(UID_F,GID_F)$:
\begin{tabular}{ll}
If & then $P$rocess has w.r.t. $F$ile \\ 
\hline
\texttt{if($UID_P$ == 0)} & \dots{} all rights \\
\texttt{else if($UID_P$ == $UID_F$)} & \dots{} owner rights \\
\texttt{else if($GID_P$ == $GID_F$ ||} &\\
\texttt{~~~~~~~~$GID_F \in SUPG$)} & \dots{} group rights \\
\texttt{else} & \dots{} rights of others
\end{tabular}
\end{itemize}
\end{slide}

\begin{itemize}
\item procesy superu¾ivatele \texttt{root} mohou mìnit svoji u¾ivatelskou a
skupinovou identitu. Toho vyu¾ívá napø. proces \texttt{login}, který bì¾í jako
\texttt{root} a po zkontrolování jména a hesla spustí shell s u¾ivatelskou
identitou (pomocí volání \texttt{setuid} -- viz dal¹í slajdy).
\item z algoritmu plyne, ¾e pro \texttt{root}a není relevantní nastavení práv
(má v¾dy neomezený pøístup). Pokud se shoduje u¾ivatel, nepou¾ijí se nikdy práva
skupiny nebo ostatních, i kdy¾ povolují více ne¾ u¾ivatelská práva. Podobnì
práva ostatních se nepou¾ijí, jestli¾e se shoduje skupinová identita. \emsl{Tedy
pokud má mùj soubor nastaveny práva \texttt{---rwxrwx}, nemohu ho èíst,
zapisovat ani spustit, dokud nastavení práv nezmìním.}
\item èím dál víc systémù se odklání od klasického modelu, kdy mnoho procesù
bì¾elo pod u¾ivatelem s UID 0 a pøi bezpeènostní chybì v takové aplikaci èasto
útoèník získal vládu nad celým systémem a zavádìjí modely jako je \emph{least
privilege model} v Solarisu nebo \emph{privilege separation} a \emph{pledge}
v OpenBSD.
\item \label{FILEDELETE} opakování z prvního roèníku -- aby u¾ivatel mohl smazat
soubor, musí mít právo zápisu do daného \emsl{adresáøe}, proto¾e to je ten
``soubor'', co se mìní. \emsl{Práva k mazanému souboru nejsou podstatná}; to ¾e
vás shell upozorní, ¾e ma¾ete soubor, ke kterému nemáte právo zápisu, je pouze
vìc toho shellu. Je to logické -- pokud si nastavíte soubor jako read-only,
shell usuzuje, ¾e ho asi normálnì mazat nechcete. Viz pøíklad pod tímto
odstavcem. \emsl{Unixové systémy nemají delete-like operaci na soubor}, smazání
souboru nastane automaticky tehdy, kdy¾ na soubor není ¾ádný odkaz z adresáøové
struktury, a nikdo soubor ji¾ nemá otevøený.

\begin{verbatim}
$ whoami
janp
$ ls -ld janp-dir
drwx------   2 janp  staff  512 Mar 23 12:12 janp-dir/
$ ls -l janp-dir
total 0
-rw-r--r--   1 root  root     0 Mar 23 12:11 root_wuz_here.txt
$ rm janp-dir/root_wuz_here.txt 
rm: janp-dir/root_wuz_here.txt: override protection 644 (yes/no)? yes
$ ls janp-dir/root_wuz_here.txt 
janp-dir/root_wuz_here.txt: No such file or directory
\end{verbatim}
\item pokud ale \texttt{root} vytvoøí v adresáøi \texttt{janp-dir} svùj
podadresáø a tam vlo¾í svùj soubor, u¾ivatel \texttt{janp} u¾ nemù¾e
adresáø \texttt{janp-dir} a jeho obsah smazat, proto¾e:
\begin{itemize}
\item podadresáø nelze smazat proto¾e není prázdný
\item a daný soubor nelze smazat z toho dùvodu, ¾e \texttt{janp} není vlastníkem
podadresáøe.
\end{itemize}
\item Pokud odeberu adresáøi read bit, není mo¾né èíst jeho obsah, tedy
provádìt výpis souborù v nìm obsa¾ených. Pokud ale znám jméno souboru v
adresáøi a execute bit je nastaven, mohu soubor pøeèíst:
\begin{verbatim}
$ mkdir foo
$ ls -ald foo
drwxr-xr-x  2 vladimirkotal  staff  68 Nov  5 14:37 foo
$ touch foo/bar
$ file foo/bar
foo/bar: empty
$ ls foo
bar
$ chmod u-r foo
$ ls foo
ls: foo: Permission denied
$ file foo/bar
foo/bar: empty
\end{verbatim}
\item existuje situace, kdy ani právo zápisu (a execute) pro adresáø nestaèí. To
se pou¾ívá u \texttt{tmp} adresáøù, do kterých mù¾e ka¾dý psát, ale není ¾ádoucí
situace, kdy by si u¾ivatelé navzájem mazali soubory. K tomu se pou¾ívá tzv.
\emph{sticky bit} (01000). Systémy mají vet¹inou manuálovou stránku
\texttt{sticky}, kde je funkce sticky bitu popsaná. Na výpisu \texttt{ls} je
oznaèovaný jako \texttt{\emsl{t}}:

\begin{verbatim}
$ ls -ld /tmp
drwxrwxrwt   7 root     root         515 Mar 23 12:22 /tmp
\end{verbatim}
\end{itemize}


%%%%%

\pdfbookmark[1]{ruid, euid, suid}{resugid}

\begin{slide}
\sltitle{Real and effective UID/GID}
\begin{itemize}
\item for each process the following IDs are distinguished:
    \begin{itemize}
    \item \emsl{real UID} (RUID) -- real owner of the process
    \item \emsl{effective UID} (EUID) -- user, whose rights are used by the
process
    \item \emsl{saved UID} -- original effective UID
    \end{itemize}
\item similarly each process has real, effective and saved GID.
\item usually \texttt{RUID==EUID \&\& RGID==EGID}.
\item \emsl{right vesting} \dots{} execution of a program with
SUID (\emsl{set user ID}) bit set changes EUID and saved UID of the process
to the UID of the program owner, RUID stays the same.
\item similarly SGID bit changes EGID of the process. 
\item \emsl{access rights checking always consults EUID, EGID a
supplementary GIDs}
\end{itemize}
\end{slide}

\label{ROOT_SETUID}

\begin{itemize}
\item \label{SUID_BIT} bity SUID a SGID se pou¾ívají u programù, které potøebují vìt¹í
pøístupová práva, ne¾ má u¾ivatel, jen¾ je spou¹tí. Pøíkladem je program
\texttt{passwd}, který musí aktualizovat soubory \texttt{/etc/passwd} a
\texttt{/etc/shadow}, kde ten první ne\-mù\-¾e bì¾ný u¾ivatel mìnit a druhý z
nich ani èíst. Dal¹í pøíklad je program \texttt{su}. Ten musí mít právo
libovolnì zmìnit u¾ivatelskou a skupinovou identitu, co¾ je privilegium
procesù s UID 0.


\item SUID a SGID programy by mìly být peèlivì naprogramovány, aby dovolily
pouze ty operace, pro které jsou urèeny, a neumo¾nily zneu¾ít jejich
privilegia pro neoprávnìné akce (napø. spu¹tìní rootovského shellu). Zku¹enost
ukazuje, ¾e tyto programy jsou jednou z nejèastìj¹ích pøíèin bezpeènostních
problémù UNIXových systémù.
\item základním pravidlem pro SUID programy je: \emsl{nepi¹te je} pokud to
není opravdu nezbytné. Je to typické místo pro generování bezpeènostních chyb
proto¾e dobøe, tj. bezpeènì, napsat slo¾itìj¹í SUID program není jednoduché.
\item \emsl{toto jsou pravidla pro zmìny:}
\begin{itemize}
\item be¾ný u¾ivatel nemù¾e zmìnit své RUID nebo uschované SUID (vyjímka je
pøi volání \texttt{exec}, viz strana \pageref{EXEC})
\item proces mù¾e v¾dy zmìnit své EUID na to z RUID nebo z uschovaného UID.
Toto zaruèuje, ¾e v SUID programu je mo¾né libovolnì mìnit EUID mezi tím
pùvodním kterým proces získal práva vlastníka a mezi UID skuteèného u¾ivatele
který daný proces spustil.
\item \emsl{root mù¾e v¹echno}, a kdy¾ zmìní RUID, tak se zároveò zmìní i
uchované UID -- nemìlo by smysl mìnit jen jedno z nich kdy¾ kterékoli mù¾ete
pou¾ít pro nastavení EUID.
\end{itemize}
\end{itemize}

%%%%%

\pdfbookmark[1]{getuid, getgid, geteuid, getegid, getgroups}{getuid}

\begin{slide}
\sltitle{Process owner identification}
\begin{itemize}
\item \texttt{uid\_t \funnm{getuid}(void)}

returns real user ID of the calling process.
\item \texttt{uid\_t \funnm{geteuid}(void)}

returns effective user ID of the calling process.
\item \texttt{gid\_t \funnm{getgid}(void)}

returns real group ID of the calling process.
\item \texttt{gid\_t \funnm{getegid}(void)}

returns effective group ID of the calling process.
\item \texttt{int \funnm{getgroups}(int \emph{gidsz}, gid\_t \emph{glist}[])}

-- \texttt{glist} returns at most \texttt{gidsz} supplementary group
IDs of the calling process and returns number of all GIDs of the process.
\end{itemize}
\end{slide}

\begin{itemize}
\item pro reálné UID je volání \texttt{getuid}, volání \texttt{getruid}
neexistuje
\item \texttt{getgroups}: kdy¾ \texttt{gidsz~==~0}, jen vrátí poèet
skupin.  Kdy¾ \texttt{0 < gidsz < \#skupin}, vrátí \texttt{-1}.
\item v UNIXu je mnoho typù jako \verb#uid_t#, \verb#gid_t#,
\verb#size_t#, apod. Vesmìs jsou to celoèíselné typy, èasto je
najdete v \texttt{/usr/inc{}lude/sys/types.h}
\item Solaris má pøíkaz \texttt{pcred}, který jednodu¹e zobrazí informace o
identifikaci procesu:
\begin{verbatim}
$ pcred 5464
5464:   e/r/suid=1993  e/r/sgid=110
        groups: 33541 41331 110
\end{verbatim}
\end{itemize}

%%%%%

\pdfbookmark[1]{setuid, setgid, setgroups}{ownerchange}

\begin{slide}
\sltitle{Process owner change}
\begin{itemize}
\item \texttt{int \funnm{setuid}(uid\_t \emph{uid});}
    \begin{itemize}
    \item in process with EUID~==~0 sets RUID, EUID and saved-SUID to
    \texttt{uid}
    \item for other processes it sets just EUID, and \texttt{uid} must be
    either equal to RUID or saved UID
    \end{itemize}
\item \texttt{int \funnm{setgid}(gid\_t \emph{gid});} \\
similar to \texttt{setuid}, for group-IDs of the process.
\item \texttt{int \funnm{setgroups}(int \emph{ngroups},
gid\_t *\emph{gidset})} \\
sets the supplementary group IDs for the calling process. Can only be used
by superuser process.
\end{itemize}
\end{slide}

\begin{itemize}
\item o nastavení UID pro proces s EUID 0 viz také poznámky na stranì
\pageref{ROOT_SETUID}.
\item co vý¹e uvedené tedy znamená: proces s efektivními právy superu¾ivatele
mù¾e libovolnì mìnit identitu. Ostatní procesory mohou pouze støídat svá
reálná a efektivní práva.
\item program \emph{login} vyu¾ívá volání \texttt{setuid}
\item pokud chce process s UID~==~0 zmìnit svou identitu, musí
nejprve volat \texttt{setgid} a \texttt{setgroups}. Teprve pak
lze zavolat \texttt{setuid}. Pøi opaèném poøadí volání by proces
po provedení \texttt{setuid} u¾ nemìl práva na \texttt{setgid} a
\texttt{setgroups}.
\item \texttt{setgroups} není uvedeno v UNIX~98 ani UNIX~03.
\item RUID/EUID jsou ulo¾ené v záznamu tabulky procesù pro pøíslu¹ný proces a
zároveò v tzv. \emph{u-area} (viz napøíklad [Bach]). EUID v tabulce procesù se
nazývá ji¾ zmínìné uschované UID, neboli \emph{saved UID}.  Jak ji¾ bylo
øeèeno, uschované UID se pou¾ívá pro kontrolu, kdy¾ se proces chce vrátit k
EUID, se kterým byl spu¹tìn (po té, co doèasnì nastavil své EUID na UID
u¾ivatele, který proces spustil, tj. na RUID).
\item pokud tedy jako root vytvoøíte SUID program a v nìm zavoláte
\texttt{setuid} pro jakéholi UID mimo 0, ji¾ se v programu k EUID==0 nemù¾ete
vrátit (je to logické -- pøedstavte si situaci, kdy se u¾ivatel loguje do
systému). V tom pøípadì byste museli pou¾ít volání \texttt{seteuid}, které
nastavuje pouze EUID.
\item pøíklad: \example{setuid/screate-file.c}
\end{itemize}

\pdfbookmark[1]{file system}{filesys}

\begin{slide}
\sltitle{Systém souborù}
\setlength{\baselineskip}{0.8\baselineskip}
\begin{itemize}
\item adresáøe tvoøí strom, spolu se soubory acyklický graf (na
jeden soubor mù¾e existovat více odkazù). 
\item ka¾dý adresáø navíc obsahuje odkaz na sebe '\texttt{.}'
(teèka) a na nadøazený adresáø '\texttt{..}' (dvì teèky). 
\item pomocí rozhraní systému souborù se pøistupuje i k dal¹ím
entitám v~systému: 
    \begin{itemize2}
\setlength{\itemsep}{-3pt}
\setlength{\topsep}{0pt}
    \item periferní zaøízení 
    \item pojmenované roury 
    \item sokety
    \item procesy (\texttt{/proc}) 
    \item pamì» (\texttt{/dev/mem}, \texttt{/dev/kmem}) 
    \item pseudosoubory (\texttt{/dev/tty}, \texttt{/dev/fd/0},\dots) 
    \end{itemize2}
\item z pohledu jádra je ka¾dý obyèejný soubor pole bajtù. 
\item v¹echny (i sí»ové) disky jsou zapojeny do jednoho stromu.
\end{itemize}
\end{slide}

\label{DEVFS}

\begin{itemize}
\item zaøízení, soubory v \texttt{/proc}, terminály, pamì» atd. jsou v¹echno
jeden typ souborù - speciální soubory. Dal¹í typy souborù - regulární soubor
(hardlink), adresáø, pojmenovaná roura, socket, symbolický link.
\item novì vytvoøený adresáø má na sebe 2 odkazy -- jeden z nadøazeného
adresáøe, a jeden sám na sebe, '\texttt{.}':

\begin{verbatim}
$ mkdir test
$ ls -ld test
drwx------   2 janp     staff        512 Mar 23 12:46 test
\end{verbatim}

\item root mù¾e v nìkterých systémech strukturu adresáøù zacyklit, ale tím
zmate utility pro procházení filesystému; moc se cyklické struktury
nepou¾ívají. Symbolické linky na adresáøe fungují v¹ude.
\item pojmenované roury (viz strana \pageref{MKFIFO}) lze pou¾ít i mezi
procesy, které nejsou pøíbuzensky spøíznìné. Jinak fungují stejnì jako
nepojmenované roury.
\item zmiòované sokety jsou v doménì UNIX, tj. slou¾í pro komunikaci v rámci
jednoho systému. Sokety z domény INET, pøes které probíhá sí»ová komunikace,
se v systému souborù neobjevují. Sí»ová komunikace zaèíná na stranì
\pageref{NETWORKING}.
\item debuggery pou¾ívají pamì»ové obrazy procesù dostupné v \texttt{/proc}.
Ve vìt¹inì u{}nix-like systémù obsahuje podstrom \texttt{/proc} údaje o jádru
systému a bì¾ících procesech ve formì textových souborù.
\item dne¹ní moderní unixy mívají speciální filesystém \emph{devfs}, jeho¾
obsah odrá¾í aktuální konfiguraci systému co se týèe pøipojených zaøízení. Tj.
napø. pøi pøipojení USB sticku se v \texttt{/dev} objeví pøíslu¹né diskové
zaøízení. Po fyzickém odpojení zaøízení odkaz z adresáøové struktury opìt
zmizí.
\end{itemize}

\endinput
