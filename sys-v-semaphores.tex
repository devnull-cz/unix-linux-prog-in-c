
changequote([[[, ]]])

\pdfbookmark[1]{System V Semaphores}{sys-v-semaphores}

\begin{slide}
\sltitle{System V semaphore API }
\texttt{int \funnm{semget}(key\_t \emph{key}, int \emph{nsems}, int
\emph{semflg});}
\begin{itemize}
\item returns identifier of an array of \texttt{nsems} semaphores associated
with the \texttt{key} key (\texttt{IPC\_PRIVATE} key \dots{} private semaphores,
each call returns different identifier). 
\texttt{semflg} is OR-combination of access rights and constants
\texttt{IPC\_CREAT} (create if does not exist),
\texttt{IPC\_EXCL} (error, if exists). 
\end{itemize}
\texttt{int \funnm{semctl}(int \emph{semid}, int \emph{semnum},
int \emph{cmd}, ...);}
\begin{itemize}
\item controlling function, optional 4th argument \texttt{arg} is of the
\texttt{union~semun} type.
\end{itemize}
\texttt{int \funnm{semop}(int \emph{semid}, struct sembuf *\emph{sops}, size\_t
\emph{nsops});}
\begin{itemize}
\item generic operations P and V.
\end{itemize}
\end{slide}

\label{SYSVSEM}

\begin{itemize}
\item How to get the key for \texttt{semget} is explained on page
\pageref{FTOK}.
\item The most interesting property of System V semaphore implementation is
that given syscall does not operate on one semaphore but on \emsl{semaphore
array}, atomically.
Most of the time you will need just one semaphore, i.e. array of one item.
For such use the System V semaphores are needlessly complex.
\item Access rights are only for reading and writing; the execute bit does not
make sense in this context.
\item Similar API (function for creating, control and operations) is followed by
the other System V IPC mechanism as well.
\item Once the array of semaphores is created by a process, the other processes
can use \texttt{semctl()} and \texttt{semop()}, without calling
\texttt{semget()} beforehand. This is valid also for the semaphores created with
the \texttt{IPC\_PRIVATE} key, for which it is not possible to call
\texttt{semget()}, because it would create new semaphore array. This is done so
that private semaphores can be inherited across \texttt{fork} as well.
\end{itemize}

%%%%%

\begin{slide}
\sltitle{System V semaphore API: \texttt{semctl()}}
\setlength{\baselineskip}{0.9\baselineskip}
\begin{itemize}
\item \texttt{semnum} \dots{} number of semaphore in the array
\item possible values of \texttt{cmd}: 
    \begin{itemize}
    \item \texttt{GETVAL} \dots{} returns semaphore value
    \item \texttt{\emsl{SETVAL}} \dots{} \emsl{sets semaphore to value}
    \texttt{arg.val}
    \item \texttt{GETPID} \dots{} PID of the process that performed the last op.
    \item \texttt{GETNCNT} \dots{} number of processes waiting on bigger value
    \item \texttt{GETZCNT} \dots{} number of processes waiting for zero value
    \item \texttt{GETALL} \dots{} saves the values of all semaphores to
    \texttt{arg.array}
    \item \texttt{SETALL} \dots{} sets all sem. values according to
    \texttt{arg.array}
    \item \texttt{IPC\_STAT} \dots{} saves number of semaphores, access rights,
times of the last \texttt{semctl()} and \texttt{semop()} into \texttt{arg.buf}
    \item \texttt{IPC\_SET} \dots{} sets access rights
    \item \texttt{IPC\_RMID} \dots{} destroys the semaphore array
    \end{itemize}
\end{itemize}
\end{slide}

\begin{itemize}
\item The \texttt{semctl(semid, semnum, SETVAL, arg)} call corresponds to
generic semaphore operation \texttt{init(s,~n)}.
\end{itemize}

%%%%%

\begin{slide}
\sltitle{System V semaphore API: \texttt{semop()}}
\begin{itemize}
\item operation is performed atomically (i.e. either it will be done for all
semaphores or none) on \texttt{nsops} semaphores according to the array
\texttt{sops} of structures \texttt{struct~sembuf}, that contains:
    \begin{itemize}
    \item \texttt{sem\_num} \dots{} semaphore number
    \item \texttt{sem\_op} \dots{} operation
        \begin{itemize}
        \item \texttt{P(sem\_num, abs(sem\_op))} for \texttt{sem\_op < 0}
        \item \texttt{V(sem\_num, sem\_op)} for \texttt{sem\_op > 0}
        \item waiting on zero semaphore value for \texttt{sem\_op == 0} 
        \end{itemize}
    \item \texttt{sem\_flg} \dots{} OR-combination
        \begin{itemize}
        \item \texttt{IPC\_NOWAIT} \dots{} when the operation cannot be
        performed it does not wait and returns error
        \item \texttt{SEM\_UNDO} \dots{} upon process exit undo the semaphore
        operations
        \end{itemize}
    \end{itemize}
\end{itemize}
\end{slide}

\begin{itemize}
\item The atomicity across the array avoids deadlock e.g. in this situation:
two processes $A$ and $B$ will be using two semaphores for synchronization of
access to two system resources. $A$ will lock in the $(0, 1)$ order and process
$B$ will use the $(1, 0)$ order. In the moment when process $A$ locks semaphore
$0$ and $B$ locks $1$, deadlock will happen because neither process can
continue due to cyclical dependency. Using atomic operation of both semaphores
means the operation will be successful only for one process that acquires both
semaphores, the other will wait.
\item \texttt{SEM\_UNDO} ensures that upon process exit the semaphore that were
locked by the process (used as locks) will become unlocked.
\end{itemize}

%%%%%

\pdfbookmark[1]{ftok}{ftok}

\begin{slide}
\sltitle{Creating System V IPC resources}
\begin{itemize}
\item jeden proces prostøedek vytvoøí, ostatní se k nìmu pøipojí. 
\item po skonèení pou¾ívání je tøeba prostøedek IPC zru¹it. 
\item funkce \texttt{semget()}, \texttt{shmget()} a
\texttt{msgget()} mají jako první parametr klíè identifikující
prostøedek IPC. Skupina procesù, která chce komunikovat, se musí
domluvit na spoleèném klíèi. Rùzné skupiny komunikujících procesù by
mìly mít rùzné klíèe. 
\end{itemize}
\texttt{key\_t \funnm{ftok}(const char *\emph{path}, int \emph{id});}
\begin{itemize}
\item vrátí klíè odvozený ze zadaného jména souboru \texttt{path} a
èísla \texttt{id}. Pro stejné \texttt{id} a libovolnou cestu
odkazující na stejný soubor vrátí stejný klíè. Pro rùzná \texttt{id}
nebo rùzné soubory na stejném svazku vrátí rùzné klíèe. 
\end{itemize}
\end{slide}

\label{FTOK} poznámky k \texttt{ftok()}:
\begin{itemize}
\item z \texttt{id} se pou¾ije jen nejni¾¹ích 8 bitù.
\item není specifikováno, zda bude stejný klíè vrácen i po smazání a
znovuvytvoøení souboru. Vìt¹inou ne, proto¾e v klíèi se èasto odrá¾í èíslo
indexového uzlu.
\item rùzné klíèe pro rùzné soubory nejsou v¾dy zaruèené. Napø. na Linuxu se
klíè získá kombinací 16 bitù èísla i-uzlu, 8 bitù \texttt{id} a 8 bitù
vedlej¹ího èísla zaøízení. Stejný klíè pro rùzné soubory je vrácen, pokud se
èísla i-uzlù shodují na spodních 16 bitech.
\item pokud tedy nepøíbuzné procesy chtìjí pou¾ívat stejný semafor, \emsl{musí
být jmého souboru pro klíè domluveno pøedem.}
\item \label{SEM_FIXED_RACE_C} pøíklad na semafory (je to pomocí semaforù
,,opravená'' verze døívej¹ího pøí\-kla\-du \example{race/race.c} ze strany
\pageref{RACE_C}): \example{race/sem-fixed-race.c}.
\end{itemize}

\endinput
