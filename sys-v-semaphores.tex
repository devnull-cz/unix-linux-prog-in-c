
changequote([[[, ]]])

\pdfbookmark[1]{System V Semaphores}{sys-v-semaphores}

\begin{slide}
\sltitle{System V semaphore API }
\texttt{int \funnm{semget}(key\_t \emph{key}, int \emph{nsems}, int
\emph{semflg});}
\begin{itemize}
\item returns identifier of an array of \texttt{nsems} semaphores associated
with the \texttt{key} key (\texttt{IPC\_PRIVATE} key \dots{} private semaphores,
each call returns different identifier). 
\texttt{semflg} is OR-combination of access rights and constants
\texttt{IPC\_CREAT} (create if does not exist),
\texttt{IPC\_EXCL} (error, if exists). 
\end{itemize}
\texttt{int \funnm{semctl}(int \emph{semid}, int \emph{semnum},
int \emph{cmd}, ...);}
\begin{itemize}
\item controlling function, optional 4th argument \texttt{arg} is of the
\texttt{union~semun} type.
\end{itemize}
\texttt{int \funnm{semop}(int \emph{semid}, struct sembuf *\emph{sops}, size\_t
\emph{nsops});}
\begin{itemize}
\item generic operations P and V.
\end{itemize}
\end{slide}

\label{SYSVSEM}

\begin{itemize}
\item How to get the key for \texttt{semget} is explained on page
\pageref{FTOK}.
\item The most interesting property of System V semaphore implementation is
that given syscall does not operate on one semaphore but on \emsl{semaphore
array}, atomically.
Most of the time you will need just one semaphore, i.e. array of one item.
For such use the System V semaphores are needlessly complex.
\item Access rights are only for reading and writing; the execute bit does not
make sense in this context.
\item Similar API (function for creating, control and operations) is followed by
the other System V IPC mechanism as well.
\item Once the array of semaphores is created by a process, the other processes
can use \texttt{semctl()} and \texttt{semop()}, without calling
\texttt{semget()} beforehand. This is valid also for the semaphores created with
the \texttt{IPC\_PRIVATE} key, for which it is not possible to call
\texttt{semget()}, because it would create new semaphore array. This is done so
that private semaphores can be inherited across \texttt{fork} as well.
\end{itemize}

%%%%%

\begin{slide}
\sltitle{System V semaphore API: \texttt{semctl()}}
\setlength{\baselineskip}{0.9\baselineskip}
\begin{itemize}
\item \texttt{semnum} \dots{} èíslo semaforu v poli 
\item mo¾né hodnoty \texttt{cmd}: 
    \begin{itemize}
    \item \texttt{GETVAL} \dots{} vrátí hodnotu semaforu 
    \item \texttt{\emsl{SETVAL}} \dots{} \emsl{nastaví semafor na hodnotu}
    \texttt{arg.val}
    \item \texttt{GETPID} \dots{} PID procesu, který provedl
    poslední operaci 
    \item \texttt{GETNCNT} \dots{} poèet procesù èekajících na vìt¹í
    hodnotu 
    \item \texttt{GETZCNT} \dots{} poèet procesù èekajících na nulu 
    \item \texttt{GETALL} \dots{} ulo¾í hodnoty v¹ech semaforù do
    pole
    \texttt{arg.array}
    \item \texttt{SETALL} \dots{} nastaví v¹echny semafory podle
    \texttt{arg.array}
    \item \texttt{IPC\_STAT} \dots{} do \texttt{arg.buf} dá poèet
    semaforù, pøístupová práva a èasy posledních \texttt{semctl()} a
    \texttt{semop()}
    \item \texttt{IPC\_SET} \dots{} nastaví pøístupová práva 
    \item \texttt{IPC\_RMID} \dots{} zru¹í pole semaforù
    \end{itemize}
\end{itemize}
\end{slide}

\begin{itemize}
\item volání \texttt{semctl(semid, semnum, SETVAL, arg)} odpovídá obecné
semaforové inicializaèní operaci \texttt{init(s,~n)}.
\end{itemize}

%%%%%

\begin{slide}
\sltitle{System V semaphore API: \texttt{semop()}}
\begin{itemize}
\item operace se provádí atomicky (tj. buï se povede pro v¹echny
semafory, nebo pro ¾ádný) na \texttt{nsops} semaforech podle pole
\texttt{sops} struktur \texttt{struct~sembuf}, která obsahuje: 
    \begin{itemize}
    \item \texttt{sem\_num} \dots{} èíslo semaforu 
    \item \texttt{sem\_op} \dots{} operace 
        \begin{itemize}
        \item \texttt{P(sem\_num, abs(sem\_op))} pro \texttt{sem\_op < 0}
        \item \texttt{V(sem\_num, sem\_op)} pro \texttt{sem\_op > 0}
        \item èekání na nulovou hodnotu semaforu pro \texttt{sem\_op == 0} 
        \end{itemize}
    \item \texttt{sem\_flg} \dots{} OR-kombinace 
        \begin{itemize}
        \item \texttt{IPC\_NOWAIT} \dots{} kdy¾ nelze operaci hned provést,
        neèeká a vrátí chybu 
        \item \texttt{SEM\_UNDO} \dots{} pøi ukonèení procesu vrátit
        operace se semaforem
        \end{itemize}
    \end{itemize}
\end{itemize}
\end{slide}

\begin{itemize}
\item atomiènost pøes mno¾inu semaforù zajistí, ¾e nedojde k deadlocku
v následující situaci: dva procesy $A$ a $B$ budou pou¾ívat dva semafory k
øízení pøístupu (zamykání) ke dvìma systémovým zdrojùm. Proces $A$ je bude
zamykat v poøadí $(0, 1)$ a proces $B$ v poøadí $(1, 0)$. Ve chvíli,
kdy proces $A$ zamkne semafor $0$ a $B$ zamkne $1$, dojde k
deadlocku, proto¾e ani jeden proces nemù¾e pokraèovat (potøeboval by
zamknout druhý semafor). Pøi pou¾ití atomické operace zamèení obou
semaforù najednou bude úspì¹ný v¾dy právì jeden proces, který získá
oba semafory, druhý bude èekat.
\item \texttt{SEM\_UNDO} zajistí, ¾e pøi ukonèení procesu dojde k odemèení
semaforù (po\-u\-¾i\-tých jako zámky), které tento proces mìl zamèené.
\end{itemize}

%%%%%

\pdfbookmark[1]{ftok}{ftok}

\begin{slide}
\sltitle{Creating System V IPC resources}
\begin{itemize}
\item jeden proces prostøedek vytvoøí, ostatní se k nìmu pøipojí. 
\item po skonèení pou¾ívání je tøeba prostøedek IPC zru¹it. 
\item funkce \texttt{semget()}, \texttt{shmget()} a
\texttt{msgget()} mají jako první parametr klíè identifikující
prostøedek IPC. Skupina procesù, která chce komunikovat, se musí
domluvit na spoleèném klíèi. Rùzné skupiny komunikujících procesù by
mìly mít rùzné klíèe. 
\end{itemize}
\texttt{key\_t \funnm{ftok}(const char *\emph{path}, int \emph{id});}
\begin{itemize}
\item vrátí klíè odvozený ze zadaného jména souboru \texttt{path} a
èísla \texttt{id}. Pro stejné \texttt{id} a libovolnou cestu
odkazující na stejný soubor vrátí stejný klíè. Pro rùzná \texttt{id}
nebo rùzné soubory na stejném svazku vrátí rùzné klíèe. 
\end{itemize}
\end{slide}

\label{FTOK} poznámky k \texttt{ftok()}:
\begin{itemize}
\item z \texttt{id} se pou¾ije jen nejni¾¹ích 8 bitù.
\item není specifikováno, zda bude stejný klíè vrácen i po smazání a
znovuvytvoøení souboru. Vìt¹inou ne, proto¾e v klíèi se èasto odrá¾í èíslo
indexového uzlu.
\item rùzné klíèe pro rùzné soubory nejsou v¾dy zaruèené. Napø. na Linuxu se
klíè získá kombinací 16 bitù èísla i-uzlu, 8 bitù \texttt{id} a 8 bitù
vedlej¹ího èísla zaøízení. Stejný klíè pro rùzné soubory je vrácen, pokud se
èísla i-uzlù shodují na spodních 16 bitech.
\item pokud tedy nepøíbuzné procesy chtìjí pou¾ívat stejný semafor, \emsl{musí
být jmého souboru pro klíè domluveno pøedem.}
\item \label{SEM_FIXED_RACE_C} pøíklad na semafory (je to pomocí semaforù
,,opravená'' verze døívej¹ího pøí\-kla\-du \example{race/race.c} ze strany
\pageref{RACE_C}): \example{race/sem-fixed-race.c}.
\end{itemize}

\endinput
